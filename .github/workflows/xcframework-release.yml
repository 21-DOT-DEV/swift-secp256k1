


name: XCFramework Release
on:
  release:
    types: [published]
jobs:
  macos:
    name: Build XCFramework
    runs-on: macos-15
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Generate Xcode project
        run: swift package --disable-sandbox tuist generate -p Projects/ --no-open
      - name: Archive & Create XCFramework
        run: |
            # Define workspace and scheme
            WORKSPACE='Projects/XCFramework.xcworkspace'
            SCHEME='P256K'
            CONFIGURATION='Release'
            ARCHIVE_DIR='Archives'

            # Platforms to archive
            PLATFORMS=(
              "iOS"
              "iOS Simulator"
              "macOS"
              "tvOS"
              "tvOS Simulator"
              "watchOS"
              "watchOS Simulator"
              "visionOS"
            )

            # Loop over platforms and archive for each one
            for PLATFORM in "${PLATFORMS[@]}"; do
              echo "Archiving for $PLATFORM..."

              # Run xcodebuild archive for each platform
              xcodebuild archive \
                -workspace "$WORKSPACE" \
                -scheme "$SCHEME" \
                -configuration "$CONFIGURATION" \
                -destination "generic/platform=$PLATFORM" \
                -archivePath "$ARCHIVE_DIR/P256K-$PLATFORM.xcarchive"

              # Check if archive command was successful
              if [ $? -eq 0 ]; then
                echo "$PLATFORM archive created successfully."
              else
                echo "Failed to archive for $PLATFORM. Exiting."
                exit 1
              fi
            done

            echo "All archives completed successfully."

            # Create an XCFramework to support multiple platforms and architectures
            # Each -archive parameter specifies a path to a .xcarchive built for a different platform
            # -framework specifies the framework within those archives to include in the XCFramework
            # The -output parameter specifies the name and location of the XCFramework to be created
            xcodebuild -create-xcframework \
              -archive "Archives/P256K-iOS.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-iOS Simulator.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-macOS.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-tvOS.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-tvOS Simulator.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-watchOS.xcarchive" -framework P256K.framework \
              -archive "Archives/P256K-watchOS Simulator.xcarchive" -framework P256K.framework \
              -output P256K.xcframework

            # Workaround for Swift issue SR-14195/GitHub #56573:
            # When a module has the same name as a type it contains (P256K in this case),
            # Swift generates invalid module interfaces with incorrect type qualifications.
            # This leads to imports failing with errors like:
            # "TypeName is not a member type of class ModuleName.ModuleName"
            #
            # This script fixes generated .swiftinterface files by:
            # 1. Removing double-qualification of the P256K type
            # 2. Fixing references to other types that don't need module qualification
            # See: https://github.com/swiftlang/swift/issues/56573
            find P256K.xcframework -name '*.swiftinterface' -print0 \
              | xargs -0 sed -i '' \
                  -e 's/extension P256K\.P256K/extension P256K/g' \
                  -e 's/P256K\.P256K\./P256K\./g' \
                  -e 's/[[:<:]]P256K\.secp256k1Error[[:>:]]/secp256k1Error/g' \
                  -e 's/[[:<:]]P256K\.Digest[[:>:]]/Digest/g' \
                  -e 's/[[:<:]]P256K\.CryptoKitError[[:>:]]/CryptoKitError/g' \
                  -e 's/[[:<:]]P256K\.CryptoKitASN1Error[[:>:]]/CryptoKitASN1Error/g' \
                  -e 's/[[:<:]]P256K\.SHA256Digest[[:>:]]/SHA256Digest/g' \
                  -e 's/[[:<:]]P256K\.XonlyKeyImplementation[[:>:]]/XonlyKeyImplementation/g' \
                  -e 's/[[:<:]]P256K\.HashDigest[[:>:]]/HashDigest/g' \
                  -e 's/[[:<:]]P256K\.SharedSecret[[:>:]]/SharedSecret/g' \
                  -e 's/[[:<:]]P256K\.PublicKeyImplementation[[:>:]]/PublicKeyImplementation/g' \
                  -e 's/[[:<:]]P256K\.PrivateKeyImplementation[[:>:]]/PrivateKeyImplementation/g'
      - name: 7z XCFramework
        run: |
          7z a -tzip -mx=9 P256K.xcframework.zip P256K.xcframework
      - name: Upload XCFramework
        run: |
          gh release upload ${{ github.ref_name }} P256K.xcframework.zip